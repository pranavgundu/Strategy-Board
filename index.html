<!doctype html>
<html style="background-color: #192334">
    <head>
        <title>Strategy Board</title>
        <meta name="description" content="FRC Strategy Board" />
        <link rel="icon" href="/favicon/favicon.ico" />
        <link
            rel="apple-touch-icon"
            href="favicon/apple-touch-icon.png"
            sizes="180x180"
        />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta
            name="apple-mobile-web-app-status-bar-style"
            content="black-translucent"
        />
        <meta
            name="viewport"
            content="width=device-width,initial-scale=1,user-scalable=no"
        />
        <meta name="theme-color" content="#000000" />
        <style>
            @import "tailwindcss";

            @theme {
                --breakpoint-md: 60rem;
                --breakpoint-lg: 80rem;
            }
        </style>
        <!-- Clear button click handler removed from inline HTML.
             The application View (TypeScript) now attaches the click handler during initialization. -->
        <style id="app-debug-styles">
            /* App debug overlay styles */
            #app-debug-overlay {
                position: fixed;
                right: 12px;
                top: 12px;
                z-index: 99999;
                background: rgba(0, 0, 0, 0.88);
                color: #fff;
                padding: 12px;
                border-radius: 10px;
                font-family:
                    system-ui,
                    -apple-system,
                    "Segoe UI",
                    Roboto,
                    "Helvetica Neue",
                    Arial,
                    monospace;
                font-size: 13px;
                max-width: 360px;
                box-shadow: 0 6px 24px rgba(0, 0, 0, 0.6);
            }
            #app-debug-overlay.hidden {
                display: none;
            }
            #app-debug-overlay .status {
                font-weight: 700;
                margin-bottom: 8px;
            }
            #app-debug-overlay pre {
                white-space: pre-wrap;
                max-height: 200px;
                overflow: auto;
                background: rgba(255, 255, 255, 0.03);
                padding: 8px;
                border-radius: 6px;
                margin-top: 8px;
                font-family: monospace;
                font-size: 12px;
            }
            #app-debug-overlay button {
                background: rgba(255, 255, 255, 0.06);
                color: #fff;
                border: 0;
                padding: 6px 8px;
                margin-right: 6px;
                cursor: pointer;
                border-radius: 6px;
            }

            /* Responsive toolbar + QR overlay visuals and animations */
            /* Keep the mode selector centered while allowing left/right controls to adapt */
            #whiteboard-toolbar {
                display: grid;
                grid-template-columns: 1fr auto 1fr;
                align-items: center;
                position: relative;
                gap: 0.5rem;
            }
            #whiteboard-toolbar .toolbar-left {
                justify-self: start;
                min-width: 0;
                display: flex;
                align-items: center;
            }
            #whiteboard-toolbar .toolbar-right {
                justify-self: end;
                min-width: 0;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            #whiteboard-toolbar #whiteboard-toolbar-mode-select {
                justify-self: center;
                white-space: nowrap;
                min-width: 0;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* Collapsed/stacked toolbar variant used when the center would collide with the right
               controls (applies automatically via JavaScript). This forces the mode selector onto its
               own row so Toggle View / Endgame / etc. can't overlap it on narrow/tablet displays. */
            #whiteboard-toolbar.toolbar-collapsed {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto;
                gap: 6px;
            }
            #whiteboard-toolbar.toolbar-collapsed .toolbar-left {
                grid-column: 1;
                grid-row: 1;
                justify-self: start;
            }
            #whiteboard-toolbar.toolbar-collapsed .toolbar-right {
                grid-column: 2;
                grid-row: 1;
                justify-self: end;
            }
            #whiteboard-toolbar.toolbar-collapsed
                #whiteboard-toolbar-mode-select {
                grid-column: 1 / -1;
                grid-row: 2;
                justify-self: center;
                white-space: normal;
            }

            /* Ensure right-side buttons don't shrink into the center label (avoid overlap) */
            #whiteboard-toolbar .toolbar-right button {
                flex-shrink: 0;
            }

            /* On tablets and smaller screens, stack controls into two rows so items don't collide */
            @media (max-width: 1024px) {
                /* Tablet layout: left + right controls share the top row, mode selector
                   is moved to its own second row and spans both columns so it cannot
                   collide with Toggle/Endgame on iPad widths. Buttons are slightly
                   reduced in padding/size to avoid overlap. */
                #whiteboard-toolbar {
                    grid-template-columns: 1fr 1fr;
                    grid-template-rows: auto auto;
                    gap: 8px;
                    height: auto;
                    padding: 8px 12px;
                    align-items: center;
                }
                #whiteboard-toolbar .toolbar-left {
                    grid-row: 1;
                    grid-column: 1 / 2;
                    justify-self: start;
                    padding-left: 0;
                    display: flex;
                    gap: 8px;
                }
                #whiteboard-toolbar .toolbar-right {
                    grid-row: 1;
                    grid-column: 2 / 3;
                    justify-self: end;
                    padding-right: 0;
                    display: flex;
                    justify-content: flex-end;
                    gap: 8px;
                }
                #whiteboard-toolbar #whiteboard-toolbar-mode-select {
                    /* Put mode labels on a dedicated row and allow them to span both columns. */
                    grid-row: 2;
                    grid-column: 1 / -1; /* span both columns */
                    justify-self: center;
                    gap: 0.75rem;
                    font-size: 1rem; /* slightly smaller on tablets */
                    flex-wrap: nowrap;
                }
                /* Slightly shrink toolbar button visuals on tablet so they don't collide. */
                #whiteboard-toolbar .toolbar-right button,
                #whiteboard-toolbar .toolbar-left button {
                    padding: 6px 10px;
                    font-size: 0.9rem;
                    height: auto;
                    min-width: 70px;
                    white-space: nowrap;
                    flex-shrink: 0;
                }
            }

            /* On narrower phones, stack into three rows (left, mode, right) so items never overlap. */
            @media (max-width: 640px) {
                #whiteboard-toolbar {
                    grid-template-columns: 1fr;
                    grid-template-rows: auto auto auto;
                    gap: 6px;
                    height: auto;
                    padding: 6px 8px;
                }
                #whiteboard-toolbar .toolbar-left {
                    grid-row: 1;
                    grid-column: 1;
                    justify-self: start;
                    padding-left: 8px;
                }
                #whiteboard-toolbar #whiteboard-toolbar-mode-select {
                    grid-row: 2;
                    grid-column: 1;
                    gap: 0.5rem;
                    font-size: 0.95rem;
                }
                #whiteboard-toolbar .toolbar-right {
                    grid-row: 3;
                    grid-column: 1;
                    justify-self: center;
                    padding-right: 0;
                }
                #whiteboard-toolbar .toolbar-right button,
                #whiteboard-toolbar .toolbar-left button {
                    padding: 5px 6px;
                    font-size: 0.85rem;
                }
            }

            /* Progress bar / QR overlay animations */
            .qr-progress-wrap {
                width: 90%;
                height: 10px;
                background: rgba(255, 255, 255, 0.08);
                border-radius: 999px;
                overflow: hidden;
                margin-top: 6px;
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.03);
            }
            .qr-progress-bar {
                width: 0%;
                height: 100%;
                border-radius: 999px;
                background: linear-gradient(90deg, #4f46e5 0%, #06b6d4 60%);
                transition: width 300ms ease-out;
                position: relative;
                overflow: hidden;
                will-change: width;
            }
            /* subtle sheen overlay on top of bar */
            .qr-progress-bar::after {
                /* Single subtle sheen overlay for a continuous, fluid bar appearance.
                   No stripes or animations to avoid visual segmentation on iPads. */
                content: "";
                position: absolute;
                left: 0;
                top: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(
                    to right,
                    rgba(255, 255, 255, 0.08),
                    rgba(255, 255, 255, 0)
                );
                opacity: 0.15;
                pointer-events: none;
            }
            /* completed state for a neat glow */
            .qr-progress-bar.complete {
                box-shadow:
                    0 0 18px rgba(34, 197, 94, 0.25),
                    inset 0 -1px 4px rgba(0, 0, 0, 0.12);
            }

            /* Hide the per-worker textual labels that were previously appended next to each canvas;
                       keep the top status/progress bar as the single authoritative progress indicator. */
            #qr-export-code-worker-0 > div,
            #qr-export-code-worker-1 > div,
            #qr-export-code-worker-2 > div {
                display: none !important;
            }

            /* Small adjustments to ensure the export overlay scales on mobile/ipad */
            #qr-export-inner-container,
            #qr-import-inner-container {
                max-width: min(92vw, 820px);
                width: 92vw;
            }
        </style>
        <script>
            (function () {
                function qs(id) {
                    return document.getElementById(id);
                }
                function log(msg) {
                    try {
                        var l = qs("app-debug-log");
                        if (l)
                            l.textContent +=
                                new Date().toLocaleTimeString() +
                                " - " +
                                msg +
                                "\n";
                    } catch (e) {}
                    console.log("APP-DEBUG:", msg);
                }

                // Instrument addEventListener to surface startup handler attachments.
                // This runs early in the page lifecycle so it can capture when the View attaches
                // event handlers to known elements during initialization.
                (function () {
                    const originalAdd = EventTarget.prototype.addEventListener;
                    EventTarget.prototype.addEventListener = function (
                        type,
                        listener,
                        options,
                    ) {
                        try {
                            const el =
                                this instanceof Element
                                    ? this
                                    : this && this.target
                                      ? this.target
                                      : null;
                            const id = el && el.id ? el.id : null;
                            const tracked = [
                                "home-toolbar-new-btn",
                                "home-toolbar-import-btn",
                                "home-toolbar-clear-btn",
                                "create-match-create-btn",
                                "create-match-cancel-btn",
                                "whiteboard-toolbar-back",
                                "whiteboard-toolbar-view-toggle",
                                "qr-export-container",
                                "qr-import-container",
                                "qr-import-inner-container",
                            ];
                            if (id && tracked.indexOf(id) !== -1) {
                                try {
                                    log(
                                        `Attached handler: "${type}" on #${id}`,
                                    );
                                } catch (err) {
                                    console.log(
                                        "APP-DEBUG: Attached handler:",
                                        type,
                                        id,
                                    );
                                }
                            }
                        } catch (err) {
                            // Non-fatal; don't break app initialization if instrumentation fails.
                            console.warn("Instrumentation failed:", err);
                        }
                        return originalAdd.call(this, type, listener, options);
                    };
                })();
                function setStatus(text) {
                    var s = qs("app-debug-status");
                    if (s) s.textContent = text;
                    log("Status: " + text);
                }
                function showOverlay() {
                    var o = qs("app-debug-overlay");
                    if (o) o.classList.remove("hidden");
                }
                function hideOverlay() {
                    var o = qs("app-debug-overlay");
                    if (o) o.classList.add("hidden");
                }
                function runSelfTest() {
                    try {
                        var newBtn = qs("home-toolbar-new-btn");
                        var panel = qs("create-match-container");
                        if (!newBtn || !panel) {
                            setStatus(
                                "Self-test: required elements missing (home-toolbar-new-btn or create-match-container)",
                            );
                            showOverlay();
                            return;
                        }
                        var beforeHidden = panel.classList.contains("hidden");
                        log("Self-test: clicking New button");
                        newBtn.click();
                        setTimeout(function () {
                            var afterHidden =
                                panel.classList.contains("hidden");
                            if (beforeHidden && !afterHidden) {
                                setStatus(
                                    "Self-test passed: create panel opened; handlers attached.",
                                );
                                // close the panel to restore state
                                var cancel = qs("create-match-cancel-btn");
                                if (cancel) cancel.click();
                                setTimeout(function () {
                                    hideOverlay();
                                }, 1200);
                            } else {
                                setStatus(
                                    "Self-test failed: create panel did not open. Event handlers may not be attached.",
                                );
                                showOverlay();
                            }
                        }, 350);
                    } catch (err) {
                        setStatus(
                            "Self-test exception: " + (err && err.message),
                        );
                        showOverlay();
                    }
                }
                function onAppInitialized() {
                    setStatus("App initialized — running self-test");
                    runSelfTest();
                }
                function onModuleError(detail) {
                    setStatus(
                        "Module failed to load: " +
                            (detail && detail.message
                                ? detail.message
                                : "unknown"),
                    );
                    showOverlay();
                }
                function onRuntimeError(ev) {
                    setStatus(
                        "Runtime error: " +
                            (ev && ev.message ? ev.message : String(ev)),
                    );
                    showOverlay();
                    log("Runtime error event: " + JSON.stringify(ev));
                }
                function onUnhandledRejection(ev) {
                    setStatus(
                        "Unhandled rejection: " +
                            (ev && ev.reason
                                ? ev.reason.message || JSON.stringify(ev.reason)
                                : String(ev)),
                    );
                    showOverlay();
                    log("Unhandled rejection: " + JSON.stringify(ev));
                }

                window.addEventListener("app:initialized", function () {
                    onAppInitialized();
                });
                window.addEventListener("app:moduleerror", function (e) {
                    onModuleError(e && e.detail);
                });
                window.addEventListener("error", function (e) {
                    onRuntimeError(e && (e.error || e));
                });
                window.addEventListener("unhandledrejection", function (e) {
                    onUnhandledRejection(e);
                });

                document.addEventListener(
                    "DOMContentLoaded",
                    function () {
                        setStatus("DOMContentLoaded — awaiting module load...");
                        // fallback: if module hasn't indicated success after a short period, attempt self-test
                        setTimeout(function () {
                            // Only run the fallback self-test if the app hasn't signaled readiness.
                            try {
                                var appReady =
                                    document.documentElement.getAttribute(
                                        "data-app-ready",
                                    );
                                if (appReady === "true") {
                                    setStatus(
                                        "Fallback: app already initialized; skipping self-test",
                                    );
                                    return;
                                }
                            } catch (err) {
                                // If there's an error checking readiness, proceed with the fallback.
                            }
                            setStatus("Fallback: running self-test");
                            runSelfTest();
                        }, 1500);
                        var selfBtn = qs("app-debug-selftest-btn");
                        if (selfBtn)
                            selfBtn.addEventListener("click", runSelfTest);
                        var reloadBtn = qs("app-debug-reload-btn");
                        if (reloadBtn)
                            reloadBtn.addEventListener("click", function () {
                                location.reload();
                            });
                    },
                    { once: true },
                );
            })();
        </script>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta2/css/all.min.css"
            integrity="sha512-YWzhKL2whUzgiheMoBFwW8CKV4qpHQAEuvilg9FAn5VJUDwKZZxkJNuGM4XkWuk94WCrrwslk8yWNGmY1EduTA=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />
    </head>
    <body class="overflow-hidden">
        <div id="app-debug-overlay" class="hidden" aria-hidden="true">
            <div
                style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                "
            >
                <div id="app-debug-title" style="font-weight: 700">
                    Strategy Board — App Debug
                </div>
                <div
                    id="app-debug-timestamp"
                    style="opacity: 0.8; font-size: 12px"
                ></div>
            </div>
            <div id="app-debug-status" class="status">Starting...</div>
            <div style="margin-top: 8px">
                <button id="app-debug-selftest-btn">Run self-test</button>
                <button id="app-debug-reload-btn">Reload</button>
            </div>
            <pre id="app-debug-log"></pre>
        </div>
        <div id="home-container" class="flex flex-col w-dvw h-dvh touch-none">
            <div
                id="home-toolbar"
                class="flex items-center justify-between w-full h-24 bg-slate-600"
            >
                <div
                    id="home-toolbar-logo"
                    class="ml-12 text-2xl md:text-3xl font-extrabold text-white select-none"
                >
                    Strategy Board
                </div>
                <div class="flex mr-12 text-lg md:text-2xl text-sky-200">
                    <button
                        id="home-toolbar-new-btn"
                        class="flex items-center justify-center mr-4 w-24 md:w-36 h-12 rounded-full bg-blue-500"
                    >
                        New
                    </button>
                    <button
                        id="home-toolbar-import-btn"
                        class="flex items-center justify-center mr-4 w-24 md:w-36 h-12 rounded-full bg-blue-500"
                    >
                        Import QR
                    </button>
                    <button
                        id="home-toolbar-clear-btn"
                        class="flex items-center justify-center w-24 md:w-36 h-12 rounded-full bg-red-500"
                    >
                        Clear
                    </button>
                </div>
            </div>
            <div
                id="home-match-list"
                class="w-full p-6 flex-1 flex flex-col gap-2 items-center overflow-y-auto bg-slate-800"
            >
                <div
                    id="home-match-list-empty-placeholder"
                    class="absolute top-1/2 text-slate-300 text-xl italic"
                >
                    Click New to add matches
                </div>
                <div
                    id="home-match-list-item-template"
                    class="hidden w-full h-24 bg-slate-700 flex shrink-0 justify-between items-center"
                >
                    <div
                        class="ml-12 grow-1 basis-0 text-slate-200 font-bold text-xl md:text-2xl select-none"
                    >
                        Match Name
                    </div>
                    <div class="w-1/2 flex justify-center items-center">
                        <div
                            class="w-1/2 text-red-400 text-lg md:text-2xl text-right select-none"
                        >
                            000 000 000
                        </div>
                        <div
                            class="text-slate-200 text-lg md:text-2xl mx-6 select-none"
                        >
                            VS
                        </div>
                        <div
                            class="w-1/2 text-blue-400 text-lg md:text-2xl select-none"
                        >
                            000 000 000
                        </div>
                    </div>
                    <div class="mr-9 grow-1 basis-0 flex h-full justify-end">
                        <button
                            class="flex flex-col w-12 gap-1 items-center justify-center"
                        >
                            <div class="w-2 h-2 rounded-full bg-white"></div>
                            <div class="w-2 h-2 rounded-full bg-white"></div>
                            <div class="w-2 h-2 rounded-full bg-white"></div>
                        </button>
                        <div class="hidden flex items-center justify-center">
                            <button
                                class="w-24 p-1 mr-2 text-md md:text-xl text-slate-300 bg-blue-500 rounded-full"
                            >
                                Export
                            </button>
                            <button
                                class="w-24 p-1 text-md md:text-xl text-slate-300 bg-red-500 rounded-full"
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div
            id="create-match-container"
            class="hidden absolute top-0 left-0 w-dvw h-dvh backdrop-blur-xs touch-none"
        >
            <div
                class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex flex-col items-center justify-between w-1/2 bg-slate-600 rounded-xl"
            >
                <input
                    id="create-match-name"
                    placeholder="Match Name"
                    maxlength="25"
                    class="w-full pt-6 pb-6 text-3xl text-center text-slate-300 font-bold rounded-t-xl bg-slate-500 outline-0"
                    autocomplete="off"
                    autocapitalize="off"
                    spellcheck="false"
                />
                <div class="grid grid-cols-3 w-full">
                    <input
                        type="number"
                        id="create-match-red-1"
                        placeholder="Red 1"
                        class="text-3xl text-center text-red-400 p-4 bg-slate-700 outline-0 [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                        autocomplete="off"
                        autocapitalize="off"
                        spellcheck="false"
                    />
                    <input
                        type="number"
                        id="create-match-red-2"
                        placeholder="Red 2"
                        class="text-3xl text-center text-red-400 p-4 bg-slate-700 outline-0 [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                        autocomplete="off"
                        autocapitalize="off"
                        spellcheck="false"
                    />
                    <input
                        type="number"
                        id="create-match-red-3"
                        placeholder="Red 3"
                        class="text-3xl text-center text-red-400 p-4 bg-slate-700 outline-0 [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                        autocomplete="off"
                        autocapitalize="off"
                        spellcheck="false"
                    />
                    <input
                        type="number"
                        id="create-match-blue-1"
                        placeholder="Blue 1"
                        class="text-3xl text-center text-blue-400 p-4 bg-slate-700 outline-0 [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                        autocomplete="off"
                        autocapitalize="off"
                        spellcheck="false"
                    />
                    <input
                        type="number"
                        id="create-match-blue-2"
                        placeholder="Blue 2"
                        class="text-3xl text-center text-blue-400 p-4 bg-slate-700 outline-0 [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                        autocomplete="off"
                        autocapitalize="off"
                        spellcheck="false"
                    />
                    <input
                        type="number"
                        id="create-match-blue-3"
                        placeholder="Blue 3"
                        class="text-3xl text-center text-blue-400 p-4 bg-slate-700 outline-0 [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                        autocomplete="off"
                        autocapitalize="off"
                        spellcheck="false"
                    />
                </div>
                <div class="flex w-full">
                    <button
                        id="create-match-create-btn"
                        class="w-1/2 text-center text-2xl font-bold text-slate-300 bg-blue-500 p-6 rounded-bl-xl"
                    >
                        Create
                    </button>
                    <button
                        id="create-match-cancel-btn"
                        class="w-1/2 text-center text-2xl font-bold text-slate-300 bg-red-500 p-6 rounded-br-xl"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
        <div
            id="qr-import-container"
            class="hidden absolute top-0 left-0 w-dvw h-dvh backdrop-blur-xs touch-none"
        >
            <div
                id="qr-import-inner-container"
                class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex flex-col items-center justify-between bg-slate-600 rounded-xl p-4"
            >
                <div
                    id="qr-import-status"
                    class="mb-3 text-slate-100 font-bold select-none"
                    aria-hidden="true"
                >
                    <span id="qr-import-status-text" aria-hidden="false"></span>
                    <div
                        id="qr-import-dots"
                        class="qr-dots"
                        aria-hidden="true"
                        style="display: none"
                    >
                        <div class="qr-dot"></div>
                        <div class="qr-dot"></div>
                        <div class="qr-dot"></div>
                    </div>
                </div>

                <!-- Import progress bar (top, visible on iPad and mobile) -->
                <div
                    id="qr-import-progress-wrap"
                    class="w-full flex justify-center"
                >
                    <div
                        id="qr-import-progress"
                        class="qr-progress-wrap"
                        aria-hidden="true"
                    >
                        <div
                            id="qr-import-progress-bar"
                            class="qr-progress-bar"
                            style="width: 0%"
                        ></div>
                    </div>
                </div>

                <select
                    id="qr-import-camera-select"
                    class="text-md md:text-xl mt-3 w-full"
                ></select>
                <video
                    id="qr-import-video"
                    autoplay
                    playsinline
                    class="w-full mt-3"
                    style="max-height: 44vh"
                ></video>
            </div>
        </div>
        <div
            id="qr-export-container"
            class="hidden absolute top-0 left-0 w-dvw h-dvh backdrop-blur-xs touch-none"
        >
            <!-- Inner container: clicking inside should NOT close the overlay.
                 We use an inline stopPropagation handler so the View's click-on-overlay
                 handler only runs when the backdrop itself is clicked. -->
            <div
                id="qr-export-inner-container"
                class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 flex flex-col items-center gap-4 bg-slate-600 rounded-xl p-6"
                onclick="event.stopPropagation()"
                role="dialog"
                aria-modal="true"
            >
                <!-- Close control (explicit close button so users don't have to tap backdrop).
                     The button triggers a programmatic click on the overlay container so the
                     existing View handler handles the hide/cleanup logic. -->
                <div class="w-full flex justify-end">
                    <button
                        id="qr-export-close-btn"
                        class="text-slate-300 bg-transparent px-3 py-1 rounded-md hover:bg-slate-700"
                        title="Close export"
                        onclick="document.getElementById('qr-export-container').click()"
                    >
                        Close
                    </button>
                </div>

                <!-- Status area updated by the QR export code (e.g. "Page 1 / 3"). -->
                <div
                    id="qr-export-status"
                    class="mb-2 text-slate-100 font-bold select-none"
                    aria-hidden="true"
                >
                    <span id="qr-export-status-text" aria-hidden="false"></span>
                    <!-- Hiddenprepared flag for automation / accessibility: the app can reveal this
                         when the export is fully prepared (useful for keyboard users / AT). -->
                    <span
                        id="qr-export-prepared"
                        class="hidden"
                        aria-hidden="true"
                        >Prepared</span
                    >
                    <div
                        id="qr-export-dots"
                        class="qr-dots"
                        aria-hidden="true"
                        style="display: none"
                    >
                        <div class="qr-dot"></div>
                        <div class="qr-dot"></div>
                        <div class="qr-dot"></div>
                    </div>
                </div>

                <!-- Top progress bar: the single authoritative visual for export progress -->
                <div
                    id="qr-export-progress-wrap"
                    class="w-full flex justify-center"
                >
                    <div
                        id="qr-export-progress"
                        class="qr-progress-wrap"
                        aria-hidden="true"
                    >
                        <div
                            id="qr-export-progress-bar"
                            class="qr-progress-bar"
                            style="width: 0%"
                        ></div>
                    </div>
                </div>

                <!-- QR worker slots (kept as separate elements so the QR export code can
                     rotate canvases into them). The per-canvas numeric labels are hidden
                     via CSS so the top progress is the only textual indicator. -->
                <div
                    id="qr-export-code-worker-0"
                    class="hidden w-full flex items-center justify-center"
                    style="z-index: 1"
                ></div>
                <div
                    id="qr-export-code-worker-1"
                    class="hidden w-full flex items-center justify-center"
                    style="z-index: 2"
                ></div>
                <div
                    id="qr-export-code-worker-2"
                    class="hidden w-full flex items-center justify-center"
                    style="z-index: 3"
                ></div>
            </div>
        </div>
        <div
            id="whiteboard-container"
            class="hidden flex flex-col w-dvw h-dvh touch-none"
        >
            <div
                id="whiteboard-toolbar"
                class="relative items-center w-full h-12 md:h-16 bg-zinc-700"
                style="z-index: 999"
            >
                <div class="toolbar-left flex items-center ml-6 md:ml-12">
                    <button
                        id="whiteboard-toolbar-back"
                        class="ml-0 md:ml-0 text-xl md:text-3xl font-extrabold text-white select-none touch-none"
                    >
                        back
                    </button>
                    <button
                        id="whiteboard-toolbar-undo"
                        class="w-24 h-full ml-3 md:ml-6 text-center text-xl md:text-3xl font-bold text-amber-700 select-none touch-none"
                    >
                        undo
                    </button>
                </div>

                <div
                    id="whiteboard-toolbar-mode-select"
                    class="toolbar-center flex justify-center items-center gap-6"
                >
                    <div
                        id="whiteboard-toolbar-mode-auto"
                        class="text-xl md:text-3xl text-zinc-100 font-extrabold select-none select-none touch-none"
                    >
                        AUTO
                    </div>
                    <div
                        id="whiteboard-toolbar-mode-teleop"
                        class="text-xl md:text-3xl text-zinc-300 select-none select-none touch-none"
                    >
                        TELEOP
                    </div>
                    <div
                        id="whiteboard-toolbar-mode-endgame"
                        class="text-xl md:text-3xl text-zinc-300 select-none select-none touch-none"
                    >
                        ENDGAME
                    </div>
                </div>

                <div
                    class="toolbar-right flex items-center justify-end gap-3 mr-6 md:mr-12"
                >
                    <button
                        id="whiteboard-toolbar-view-toggle"
                        class="w-44 md:w-48 h-full text-sm md:text-xl font-bold text-zinc-300 select-none touch-none"
                    >
                        Toggle View
                    </button>

                    <!-- Export controls: export the composed field (background + items + drawing) -->
                    <div class="flex items-center gap-2 ml-2">
                        <button
                            id="whiteboard-toolbar-export-png"
                            class="w-28 md:w-32 h-full text-xs md:text-sm font-semibold text-white bg-blue-500 rounded-full px-3 py-1 select-none touch-none"
                            title="Export field + annotations as PNG"
                        >
                            Export PNG
                        </button>
                        <button
                            id="whiteboard-toolbar-export-pdf"
                            class="w-28 md:w-32 h-full text-xs md:text-sm font-semibold text-white bg-green-600 rounded-full px-3 py-1 select-none touch-none"
                            title="Export field + annotations as PDF (uses print dialog)"
                        >
                            Export PDF
                        </button>
                    </div>
                </div>
            </div>
            <div
                id="whiteboard-wrapper"
                class="w-full h-full m-0 p-0 bg-zinc-900"
            >
                <canvas
                    id="whiteboard-canvas-background"
                    width="3510"
                    height="1610"
                    class="absolute m-0 select-none touch-none"
                ></canvas>
                <canvas
                    id="whiteboard-canvas-items"
                    width="3510"
                    height="1610"
                    class="absolute m-0 select-none touch-none"
                ></canvas>
                <canvas
                    id="whiteboard-canvas-drawing"
                    width="3510"
                    height="1610"
                    class="absolute m-0 select-none touch-none"
                ></canvas>
            </div>
            <div
                id="whiteboard-robot-config"
                class="hidden absolute flex flex-col justify-center items-center w-64 h-36 top-12 right-0 bg-zinc-800 rounded-b-xl"
            >
                <div class="text-2xl text-zinc-400 font-bold mb-4 select-none">
                    Robot Config (in.)
                </div>
                <div class="flex w-full justify-center items-center">
                    <input
                        id="whiteboard-robot-config-width"
                        placeholder="width"
                        class="w-1/3 mr-4 text-3xl text-zinc-500 text-right outline-0 select-none touch-none [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                        autocomplete="off"
                        autocapitalize="off"
                        spellcheck="false"
                    />
                    <div class="text-3xl text-zinc-700 text-center outline-0">
                        x
                    </div>
                    <input
                        id="whiteboard-robot-config-height"
                        placeholder="length"
                        class="w-1/3 ml-4 text-3xl text-zinc-500 text-left outline-0 select-none touch-none [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                        autocomplete="off"
                        autocapitalize="off"
                        spellcheck="false"
                    />
                </div>
            </div>
            <div
                id="whiteboard-draw-config"
                class="absolute flex flex-col justify-center items-center size-12 md:size-16 lg:size-24 bottom-4 right-4 bg-zinc-800 rounded-full"
            >
                <i
                    id="whiteboard-draw-config-marker"
                    class="fa fa-pencil text-xl md:text-2xl lg:text-3xl text-white"
                ></i>
                <i
                    id="whiteboard-draw-config-eraser"
                    class="fa fa-eraser text-xl md:text-2xl lg:text-3xl text-white"
                    style="display: none"
                ></i>
                <i
                    id="whiteboard-draw-config-text"
                    class="fa fa-font text-xl md:text-2xl lg:text-3xl text-white"
                    style="display: none"
                ></i>
            </div>
            <div
                id="whiteboard-color-config"
                class="absolute flex flex-col justify-center items-center bottom-4 left-4 bg-zinc-800 rounded-full"
            >
                <div
                    id="whiteboard-color-yellow"
                    class="size-8 m-2 md:size-12 lg:size-16 bottom-4 right-4 bg-yellow-500 rounded-full border-amber-600"
                ></div>
                <div
                    id="whiteboard-color-green"
                    class="size-8 m-2 md:size-12 lg:size-16 bottom-4 right-4 bg-green-500 rounded-full border-amber-500"
                ></div>
                <div
                    id="whiteboard-color-blue"
                    class="size-8 m-2 md:size-12 lg:size-16 bottom-4 right-4 bg-blue-500 rounded-full border-amber-500"
                ></div>
                <div
                    id="whiteboard-color-red"
                    class="size-8 m-2 md:size-12 lg:size-16 bottom-4 right-4 bg-red-500 rounded-full border-amber-500"
                ></div>
                <div
                    id="whiteboard-color-white"
                    class="size-8 m-2 md:size-12 lg:size-16 bottom-4 right-4 bg-white rounded-full border-amber-500"
                ></div>
                <div
                    id="whiteboard-color-close"
                    class="size-8 m-2 md:size-12 lg:size-16 bottom-4 right-4 flex justify-center items-center text-center rounded-full"
                >
                    <i
                        class="fa fa-close text-xl md:text-2xl lg:text-3xl text-red-500"
                    ></i>
                </div>
            </div>
            <!-- Number pad for the text tool (hidden until text mode is active) -->
            <div
                id="whiteboard-number-pad"
                class="hidden absolute bottom-24 right-4 bg-zinc-800 rounded-xl p-3 grid grid-cols-3 gap-2 z-50"
                aria-hidden="true"
            >
                <button
                    id="whiteboard-number-1"
                    class="p-3 rounded bg-slate-700 text-white text-xl"
                >
                    1
                </button>
                <button
                    id="whiteboard-number-2"
                    class="p-3 rounded bg-slate-700 text-white text-xl"
                >
                    2
                </button>
                <button
                    id="whiteboard-number-3"
                    class="p-3 rounded bg-slate-700 text-white text-xl"
                >
                    3
                </button>

                <button
                    id="whiteboard-number-4"
                    class="p-3 rounded bg-slate-700 text-white text-xl"
                >
                    4
                </button>
                <button
                    id="whiteboard-number-5"
                    class="p-3 rounded bg-slate-700 text-white text-xl"
                >
                    5
                </button>
                <button
                    id="whiteboard-number-6"
                    class="p-3 rounded bg-slate-700 text-white text-xl"
                >
                    6
                </button>

                <button
                    id="whiteboard-number-7"
                    class="p-3 rounded bg-slate-700 text-white text-xl"
                >
                    7
                </button>
                <button
                    id="whiteboard-number-8"
                    class="p-3 rounded bg-slate-700 text-white text-xl"
                >
                    8
                </button>
                <button
                    id="whiteboard-number-9"
                    class="p-3 rounded bg-slate-700 text-white text-xl"
                >
                    9
                </button>

                <div class="col-span-3 text-center mt-1">
                    <button
                        id="whiteboard-number-0"
                        class="w-2/3 p-3 rounded bg-slate-700 text-white text-xl"
                    >
                        0
                    </button>
                </div>
            </div>
        </div>
        <script>
            // Inline export helpers: compose the three canvases (background, items, drawing)
            // into a single image and either download as PNG or open a print dialog (PDF).
            (function () {
                function compositeCanvases() {
                    var bg = document.getElementById(
                        "whiteboard-canvas-background",
                    );
                    var items = document.getElementById(
                        "whiteboard-canvas-items",
                    );
                    var drawing = document.getElementById(
                        "whiteboard-canvas-drawing",
                    );
                    if (!bg || !items || !drawing) return null;

                    var w = bg.width || bg.clientWidth || 3510;
                    var h = bg.height || bg.clientHeight || 1610;
                    var out = document.createElement("canvas");
                    out.width = w;
                    out.height = h;
                    var ctx = out.getContext("2d");
                    if (!ctx) return null;

                    // Draw in the same order we render: background, items (robots), drawing (annotations)
                    ctx.drawImage(bg, 0, 0);
                    ctx.drawImage(items, 0, 0);
                    ctx.drawImage(drawing, 0, 0);

                    return out;
                }

                function downloadDataUrl(dataUrl, filename) {
                    var a = document.createElement("a");
                    a.href = dataUrl;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                }

                function exportPNG(filename) {
                    var c = compositeCanvases();
                    if (!c) {
                        alert("Export failed: canvases not available");
                        return;
                    }
                    var dataUrl = c.toDataURL("image/png");
                    downloadDataUrl(dataUrl, filename || "strategy-board.png");
                }

                function exportPDF() {
                    var c = compositeCanvases();
                    if (!c) {
                        alert("Export failed: canvases not available");
                        return;
                    }
                    var dataUrl = c.toDataURL("image/png");

                    // Open in a new window and trigger the print dialog; user can choose "Save as PDF".
                    var w = window.open("", "_blank");
                    if (!w) {
                        alert(
                            "Popup blocked. Please allow popups to export as PDF.",
                        );
                        return;
                    }
                    w.document.write(
                        "<!doctype html><html><head><title>Strategy Board Export</title>",
                    );
                    w.document.write('</head><body style="margin:0">');
                    w.document.write(
                        '<img src="' +
                            dataUrl +
                            '" style="width:100%;height:auto;display:block" />',
                    );
                    w.document.write("</body></html>");
                    w.document.close();
                    w.focus();

                    // Wait for the image to load before printing to ensure it renders correctly.
                    var img = w.document.querySelector("img");
                    if (img) {
                        img.onload = function () {
                            setTimeout(function () {
                                try {
                                    w.print();
                                } catch (err) {
                                    // print may throw in some environments; ignore.
                                }
                                try {
                                    w.close();
                                } catch (err) {}
                            }, 250);
                        };
                    } else {
                        setTimeout(function () {
                            try {
                                w.print();
                            } catch (err) {}
                            try {
                                w.close();
                            } catch (err) {}
                        }, 500);
                    }
                }

                /* Progress observation moved to view.ts.
                   Duplicate inline parsing/observer functions removed to avoid
                   having two competing observers (index.html vs. view.ts).
                   The View module now installs MutationObservers and updates
                   the top progress bars (qr-export-progress-bar / qr-import-progress-bar). */

                function attachHandlers() {
                    var pngBtn = document.getElementById(
                        "whiteboard-toolbar-export-png",
                    );
                    var pdfBtn = document.getElementById(
                        "whiteboard-toolbar-export-pdf",
                    );
                    if (pngBtn) {
                        pngBtn.addEventListener("click", function () {
                            var ts = new Date()
                                .toISOString()
                                .replace(/[:.]/g, "-");
                            exportPNG("strategy-board-" + ts + ".png");
                        });
                    }
                    if (pdfBtn) {
                        pdfBtn.addEventListener("click", function () {
                            exportPDF();
                        });
                    }

                    // Reset progress when overlay is closed
                    var exportOverlay = document.getElementById(
                        "qr-export-container",
                    );
                    var exportProgressBar = document.getElementById(
                        "qr-export-progress-bar",
                    );
                    if (exportOverlay && exportProgressBar) {
                        // When overlay receives a click (backdrop) it will be closed by app's view logic.
                        exportOverlay.addEventListener("click", function () {
                            try {
                                exportProgressBar.style.width = "0%";
                                exportProgressBar.classList.remove("complete");
                            } catch (_err) {}
                        });
                    }
                    var importOverlay = document.getElementById(
                        "qr-import-container",
                    );
                    var importProgressBar = document.getElementById(
                        "qr-import-progress-bar",
                    );
                    if (importOverlay && importProgressBar) {
                        importOverlay.addEventListener("click", function () {
                            try {
                                importProgressBar.style.width = "0%";
                                importProgressBar.classList.remove("complete");
                            } catch (_err) {}
                        });
                    }

                    // Observe top status text nodes and animate progress accordingly.
                    // Progress observation is handled by view.ts (no duplicate observers here).
                }

                if (document.readyState === "loading") {
                    document.addEventListener(
                        "DOMContentLoaded",
                        attachHandlers,
                        { once: true },
                    );
                } else {
                    attachHandlers();
                }
            })();
        </script>

        <script
            type="module"
            src="./src/app.ts"
            id="app-module-script"
            crossorigin
            onload="document.dispatchEvent(new Event('app:moduleloaded'))"
            onerror="document.dispatchEvent(new CustomEvent('app:moduleerror',{detail:{message:'module load failed'}}))"
        ></script>
    </body>
</html>
